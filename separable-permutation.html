<input id="e" placeholder="expression"><input id="f" placeholder="flat"><input id="s" placeholder="set"><input id="v" placeholder="value"><button id="c">convert</button><button id="t">test</button><script>o={"*":l=>(r[0][0]+=l[1]-l[2],l[2]=r[2]+l[1],l[1]+=r[1],l[3](r[0]),l[3]=r[3],l),"+":l=>(r[0][0]-=l[2]+r[1],l[0][0]+=r[1],l[2]=r[2],l[1]+=r[1],l[3](r[0]),l[3]=r[3],l)};c.onclick=a=>{k=[0];for(a of e.value){let b;a.match(/[a-z]/)?k.push([b=[0,a,0],1,0,a=>b[2]=a]):o[a]&&(r=k.pop(),k.push(o[a](k.pop())))};[b,[a,f.value]]=k;while(a)b+=a[0],f.value+=` ${a[1]} `+b,a=a[2]};u=(x,l)=>{for(j=i+1;j<b&(k[2*j]-k[2*i])*x<0;j=l[j]);l[i]=j};t.onclick=a=>{k=f.value.split` `;h={};for(a of s.value)h[a]=1;m=[];l=[];r=[];for(i=b=-~k[0];--i;)u(1,m),u(-1,l),r[i]=h[k[2*i-1]]&(m[i]==b|r[m[i]])|r[l[i]];v.value=r[1]}</script>
